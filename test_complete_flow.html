<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Flow Test - J.A.I</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .step { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>üéØ Complete J.A.I Flow Test</h1>
    <p>This tests the entire flow: Request ‚Üí Accept ‚Üí Chat ‚Üí Meeting</p>
    
    <div class="step">
        <h3>Step 1: Create & Accept Request</h3>
        <button onclick="createAndAcceptRequest()">üöÄ Create & Accept Request</button>
        <div id="step1Result"></div>
    </div>
    
    <div class="step">
        <h3>Step 2: Test Chat System</h3>
        <button onclick="testChatSystem()">üí¨ Test Chat Messages</button>
        <div id="step2Result"></div>
    </div>
    
    <div class="step">
        <h3>Step 3: Open Dashboards</h3>
        <button onclick="openClientDashboard()">üë§ Open Client Dashboard</button>
        <button onclick="openLawyerDashboard()">‚öñÔ∏è Open Lawyer Dashboard</button>
        <button onclick="openChatInterface()">üí¨ Open Chat Interface</button>
        <div id="step3Result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001/api';
        let testRequestId = '';
        let clientToken = '';
        let lawyerToken = '';

        async function createAndAcceptRequest() {
            const resultDiv = document.getElementById('step1Result');
            resultDiv.innerHTML = '<div class="info">Creating and accepting request...</div>';

            try {
                // Login as client
                const clientLogin = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'client@test.com', password: 'password123' })
                });
                const clientData = await clientLogin.json();
                clientToken = clientData.access_token;

                // Login as lawyer
                const lawyerLogin = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'lawyer@test.com', password: 'password123' })
                });
                const lawyerData = await lawyerLogin.json();
                lawyerToken = lawyerData.access_token;

                // Send request
                const requestResponse = await fetch(`${API_BASE}/requests/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify({
                        lawyer_id: lawyerData.user.id,
                        title: 'Complete Flow Test Request',
                        description: 'Testing the complete flow from request to chat to meeting scheduling.',
                        category: 'General Legal Advice',
                        urgency_level: 'medium'
                    })
                });
                const requestResult = await requestResponse.json();
                testRequestId = requestResult.id;

                // Accept request
                const acceptResponse = await fetch(`${API_BASE}/requests/${testRequestId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${lawyerToken}`
                    },
                    body: JSON.stringify({
                        action: 'accept',
                        response_message: 'I accept your request and look forward to helping you.',
                        meeting_slots: [
                            { date: '2024-02-01', time: '10:00 AM', duration: 60, meeting_type: 'online' },
                            { date: '2024-02-01', time: '2:00 PM', duration: 60, meeting_type: 'online' },
                            { date: '2024-02-02', time: '11:00 AM', duration: 60, meeting_type: 'in-person' }
                        ]
                    })
                });
                const acceptResult = await acceptResponse.json();

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Request Created & Accepted!</h4>
                        <p><strong>Request ID:</strong> ${testRequestId}</p>
                        <p><strong>Client:</strong> ${clientData.user.first_name} ${clientData.user.last_name}</p>
                        <p><strong>Lawyer:</strong> ${lawyerData.user.first_name} ${lawyerData.user.last_name}</p>
                        <p><strong>Status:</strong> Accepted with meeting slots</p>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Failed: ${error.message}</div>`;
            }
        }

        async function testChatSystem() {
            if (!testRequestId || !clientToken || !lawyerToken) {
                alert('Please run Step 1 first!');
                return;
            }

            const resultDiv = document.getElementById('step2Result');
            resultDiv.innerHTML = '<div class="info">Testing chat system...</div>';

            try {
                // Send message as client
                const clientMessage = await fetch(`${API_BASE}/chat/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify({
                        request_id: testRequestId,
                        content: 'Hello! Thank you for accepting my request. I look forward to working with you.',
                        message_type: 'text'
                    })
                });
                const clientMsgResult = await clientMessage.json();

                // Send reply as lawyer
                const lawyerMessage = await fetch(`${API_BASE}/chat/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${lawyerToken}`
                    },
                    body: JSON.stringify({
                        request_id: testRequestId,
                        content: 'Hello! I\'m excited to help you with your legal needs. Please let me know if you have any questions about the available meeting times.',
                        message_type: 'text'
                    })
                });
                const lawyerMsgResult = await lawyerMessage.json();

                // Get chat conversations
                const conversationsResponse = await fetch(`${API_BASE}/chat/conversations`, {
                    headers: { 'Authorization': `Bearer ${clientToken}` }
                });
                const conversations = await conversationsResponse.json();

                // Get messages
                const messagesResponse = await fetch(`${API_BASE}/chat/${testRequestId}/messages`, {
                    headers: { 'Authorization': `Bearer ${clientToken}` }
                });
                const messages = await messagesResponse.json();

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Chat System Working!</h4>
                        <p><strong>Client Message ID:</strong> ${clientMsgResult.id}</p>
                        <p><strong>Lawyer Message ID:</strong> ${lawyerMsgResult.id}</p>
                        <p><strong>Total Conversations:</strong> ${conversations.length}</p>
                        <p><strong>Total Messages:</strong> ${messages.length}</p>
                        <p><strong>Chat Available:</strong> Both client and lawyer can now chat!</p>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Chat test failed: ${error.message}</div>`;
            }
        }

        function openClientDashboard() {
            // Set client token for dashboard
            localStorage.setItem('access_token', clientToken);
            localStorage.setItem('userType', 'client');
            window.open('client-dashboard.html', '_blank');
            
            document.getElementById('step3Result').innerHTML = `
                <div class="info">
                    <p>‚úÖ Client dashboard opened! You should see:</p>
                    <ul>
                        <li>Your request with "Chat" button (if accepted)</li>
                        <li>Meeting slots to select from</li>
                        <li>Response message from lawyer</li>
                    </ul>
                </div>
            `;
        }

        function openLawyerDashboard() {
            // Set lawyer token for dashboard
            localStorage.setItem('access_token', lawyerToken);
            localStorage.setItem('userType', 'lawyer');
            window.open('lawyer-dashboard.html', '_blank');
            
            document.getElementById('step3Result').innerHTML += `
                <div class="info">
                    <p>‚úÖ Lawyer dashboard opened! You should see:</p>
                    <ul>
                        <li>Active conversations section</li>
                        <li>Chat buttons for accepted requests</li>
                        <li>Pending requests (if any)</li>
                    </ul>
                </div>
            `;
        }

        function openChatInterface() {
            window.open('chat.html', '_blank');
            
            document.getElementById('step3Result').innerHTML += `
                <div class="info">
                    <p>‚úÖ Chat interface opened! Login as either client or lawyer to see conversations.</p>
                </div>
            `;
        }
    </script>
</body>
</html>