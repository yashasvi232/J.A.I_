<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Request Flow - J.A.I</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { padding: 12px 24px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
        .btn:hover { background: #e55555; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        .result { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .step { margin: 20px 0; padding: 20px; border: 2px solid #e9ecef; border-radius: 8px; }
        .step h3 { margin-top: 0; color: #495057; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; 
        }
        .request-item { 
            border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background: #f8f9fa; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ J.A.I Request Flow Test</h1>
        <p>This tests the complete client-to-lawyer request system</p>
        
        <!-- Step 1: Login as Client -->
        <div class="step">
            <h3>Step 1: Login as Client</h3>
            <button class="btn" onclick="loginAsClient()">üßë‚Äçüíº Login as Client</button>
            <div id="clientLoginResult"></div>
        </div>
        
        <!-- Step 2: Get Lawyers List -->
        <div class="step">
            <h3>Step 2: Get Available Lawyers</h3>
            <button class="btn" onclick="getLawyers()">üë®‚Äç‚öñÔ∏è Get Lawyers</button>
            <div id="lawyersResult"></div>
        </div>
        
        <!-- Step 3: Send Request to Lawyer -->
        <div class="step">
            <h3>Step 3: Send Request to Lawyer</h3>
            <div class="form-group">
                <label>Select Lawyer:</label>
                <select id="lawyerSelect">
                    <option value="">Select a lawyer first...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Case Title:</label>
                <input type="text" id="caseTitle" value="Family Law Consultation" placeholder="Enter case title">
            </div>
            <div class="form-group">
                <label>Category:</label>
                <select id="caseCategory">
                    <option value="Family Law">Family Law</option>
                    <option value="Corporate Law">Corporate Law</option>
                    <option value="Real Estate">Real Estate</option>
                    <option value="Criminal Defense">Criminal Defense</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description:</label>
                <textarea id="caseDescription" rows="3" placeholder="Describe your legal issue...">I need help with divorce proceedings and child custody arrangements. Looking for an experienced family law attorney.</textarea>
            </div>
            <button class="btn" onclick="sendRequest()">üì§ Send Request</button>
            <div id="requestResult"></div>
        </div>
        
        <!-- Step 4: Login as Lawyer -->
        <div class="step">
            <h3>Step 4: Login as Lawyer</h3>
            <button class="btn btn-secondary" onclick="loginAsLawyer()">‚öñÔ∏è Login as Lawyer</button>
            <div id="lawyerLoginResult"></div>
        </div>
        
        <!-- Step 5: Check Pending Requests -->
        <div class="step">
            <h3>Step 5: Check Pending Requests (Lawyer View)</h3>
            <button class="btn btn-secondary" onclick="getPendingRequests()">üìã Get Pending Requests</button>
            <div id="pendingRequestsResult"></div>
        </div>
        
        <!-- Step 6: Respond to Request -->
        <div class="step">
            <h3>Step 6: Respond to Request</h3>
            <div id="responseSection" style="display: none;">
                <div class="form-group">
                    <label>Response Message:</label>
                    <textarea id="responseMessage" rows="2" placeholder="Enter your response...">Thank you for your request. I have extensive experience in family law and would be happy to help with your case.</textarea>
                </div>
                <button class="btn" onclick="acceptRequest()">‚úÖ Accept Request</button>
                <button class="btn btn-secondary" onclick="rejectRequest()">‚ùå Reject Request</button>
            </div>
            <div id="responseResult"></div>
        </div>
        
        <div id="overallResult"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001/api';
        let clientToken = '';
        let lawyerToken = '';
        let selectedLawyerId = '';
        let currentRequestId = '';
        
        // Step 1: Login as Client
        async function loginAsClient() {
            const resultDiv = document.getElementById('clientLoginResult');
            resultDiv.innerHTML = '<div class="info">Logging in as client...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'client@test.com',
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.access_token) {
                    clientToken = data.access_token;
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Client Login Successful!</h4>
                            <p><strong>Name:</strong> ${data.user.first_name} ${data.user.last_name}</p>
                            <p><strong>Email:</strong> ${data.user.email}</p>
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Client login failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Client Login Failed</h4><p>${error.message}</p></div>`;
            }
        }
        
        // Step 2: Get Lawyers
        async function getLawyers() {
            const resultDiv = document.getElementById('lawyersResult');
            resultDiv.innerHTML = '<div class="info">Loading lawyers...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/public/lawyers`);
                const data = await response.json();
                
                if (response.ok && data.lawyers) {
                    const lawyerSelect = document.getElementById('lawyerSelect');
                    lawyerSelect.innerHTML = '<option value="">Select a lawyer...</option>';
                    
                    let lawyersHtml = '<div class="success"><h4>‚úÖ Found Lawyers:</h4>';
                    data.lawyers.forEach(lawyer => {
                        lawyersHtml += `
                            <div class="request-item">
                                <strong>${lawyer.first_name} ${lawyer.last_name}</strong><br>
                                <small>Specializations: ${lawyer.specializations ? lawyer.specializations.join(', ') : 'General Practice'}</small><br>
                                <small>Experience: ${lawyer.years_experience || 0} years</small>
                            </div>
                        `;
                        lawyerSelect.innerHTML += `<option value="${lawyer.id}">${lawyer.first_name} ${lawyer.last_name}</option>`;
                    });
                    lawyersHtml += '</div>';
                    resultDiv.innerHTML = lawyersHtml;
                } else {
                    throw new Error('No lawyers found');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Failed to Load Lawyers</h4><p>${error.message}</p></div>`;
            }
        }
        
        // Step 3: Send Request
        async function sendRequest() {
            if (!clientToken) {
                alert('Please login as client first!');
                return;
            }
            
            const lawyerId = document.getElementById('lawyerSelect').value;
            if (!lawyerId) {
                alert('Please select a lawyer!');
                return;
            }
            
            const resultDiv = document.getElementById('requestResult');
            resultDiv.innerHTML = '<div class="info">Sending request...</div>';
            
            const requestData = {
                title: document.getElementById('caseTitle').value,
                description: document.getElementById('caseDescription').value,
                category: document.getElementById('caseCategory').value,
                urgency_level: 'medium',
                lawyer_id: lawyerId
            };
            
            try {
                const response = await fetch(`${API_BASE}/requests/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentRequestId = data.id;
                    selectedLawyerId = lawyerId;
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Request Sent Successfully!</h4>
                            <p><strong>Request ID:</strong> ${data.id}</p>
                            <p><strong>Title:</strong> ${requestData.title}</p>
                            <p><strong>Category:</strong> ${requestData.category}</p>
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Failed to send request');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Failed to Send Request</h4><p>${error.message}</p></div>`;
            }
        }
        
        // Step 4: Login as Lawyer
        async function loginAsLawyer() {
            const resultDiv = document.getElementById('lawyerLoginResult');
            resultDiv.innerHTML = '<div class="info">Logging in as lawyer...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'lawyer@test.com',
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.access_token) {
                    lawyerToken = data.access_token;
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Lawyer Login Successful!</h4>
                            <p><strong>Name:</strong> ${data.user.first_name} ${data.user.last_name}</p>
                            <p><strong>Email:</strong> ${data.user.email}</p>
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Lawyer login failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Lawyer Login Failed</h4><p>${error.message}</p></div>`;
            }
        }
        
        // Step 5: Get Pending Requests
        async function getPendingRequests() {
            if (!lawyerToken) {
                alert('Please login as lawyer first!');
                return;
            }
            
            const resultDiv = document.getElementById('pendingRequestsResult');
            resultDiv.innerHTML = '<div class="info">Loading pending requests...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/requests/pending`, {
                    headers: {
                        'Authorization': `Bearer ${lawyerToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.length === 0) {
                        resultDiv.innerHTML = '<div class="warning"><h4>‚ö†Ô∏è No Pending Requests</h4><p>No requests found. Make sure you sent a request in Step 3.</p></div>';
                    } else {
                        let requestsHtml = '<div class="success"><h4>‚úÖ Pending Requests Found:</h4>';
                        data.forEach(request => {
                            requestsHtml += `
                                <div class="request-item">
                                    <strong>${request.title}</strong><br>
                                    <small><strong>From:</strong> ${request.client_name}</small><br>
                                    <small><strong>Category:</strong> ${request.category}</small><br>
                                    <small><strong>Urgency:</strong> ${request.urgency_level}</small><br>
                                    <p>${request.description}</p>
                                    <small><strong>Date:</strong> ${new Date(request.created_at).toLocaleDateString()}</small>
                                </div>
                            `;
                            if (request.id === currentRequestId) {
                                document.getElementById('responseSection').style.display = 'block';
                            }
                        });
                        requestsHtml += '</div>';
                        resultDiv.innerHTML = requestsHtml;
                    }
                } else {
                    throw new Error(data.detail || 'Failed to load pending requests');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Failed to Load Requests</h4><p>${error.message}</p></div>`;
            }
        }
        
        // Step 6: Accept Request
        async function acceptRequest() {
            if (!currentRequestId) {
                alert('No request to respond to!');
                return;
            }
            
            const resultDiv = document.getElementById('responseResult');
            resultDiv.innerHTML = '<div class="info">Accepting request...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/requests/${currentRequestId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${lawyerToken}`
                    },
                    body: JSON.stringify({
                        action: 'accept',
                        response_message: document.getElementById('responseMessage').value
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Request Accepted Successfully!</h4>
                            <p>${data.message}</p>
                            <p><strong>Case Created:</strong> ${data.case_created ? 'Yes' : 'No'}</p>
                        </div>
                    `;
                    
                    document.getElementById('overallResult').innerHTML = `
                        <div class="success" style="margin-top: 30px; padding: 20px; border: 3px solid #28a745;">
                            <h2>üéâ Request Flow Test SUCCESSFUL!</h2>
                            <p>The complete client-to-lawyer request system is working perfectly:</p>
                            <ul>
                                <li>‚úÖ Client can login and send requests</li>
                                <li>‚úÖ Lawyers can see pending requests</li>
                                <li>‚úÖ Lawyers can accept/reject requests</li>
                                <li>‚úÖ Cases are created when requests are accepted</li>
                            </ul>
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Failed to accept request');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Failed to Accept Request</h4><p>${error.message}</p></div>`;
            }
        }
        
        // Step 6: Reject Request
        async function rejectRequest() {
            if (!currentRequestId) {
                alert('No request to respond to!');
                return;
            }
            
            const resultDiv = document.getElementById('responseResult');
            resultDiv.innerHTML = '<div class="info">Rejecting request...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/requests/${currentRequestId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${lawyerToken}`
                    },
                    body: JSON.stringify({
                        action: 'reject',
                        response_message: document.getElementById('responseMessage').value
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            <h4>‚ö†Ô∏è Request Rejected</h4>
                            <p>${data.message}</p>
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Failed to reject request');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Failed to Reject Request</h4><p>${error.message}</p></div>`;
            }
        }
    </script>
</body>
</html>