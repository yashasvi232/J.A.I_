<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Chat System - J.A.I</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .step { margin: 20px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó®Ô∏è J.A.I Chat System Test</h1>
        <p>This tests the complete chat functionality for accepted requests between clients and lawyers.</p>
        
        <!-- Step 1: Setup Test Request -->
        <div class="step">
            <h3>Step 1: Create and Accept Test Request</h3>
            <button class="btn" onclick="setupTestRequest()">üöÄ Setup Test Request & Accept</button>
            <div id="setupResult"></div>
        </div>
        
        <!-- Step 2: Test Chat -->
        <div class="step">
            <h3>Step 2: Test Chat Functionality</h3>
            <button class="btn" onclick="testChatConversations()">üí¨ Load Chat Conversations</button>
            <button class="btn" onclick="sendTestMessage()">üì§ Send Test Message</button>
            <button class="btn" onclick="loadChatMessages()">üì• Load Chat Messages</button>
            <div id="chatResult"></div>
        </div>
        
        <!-- Step 3: Open Chat Interface -->
        <div class="step">
            <h3>Step 3: Open Full Chat Interface</h3>
            <button class="btn" onclick="openChatInterface()">üó®Ô∏è Open Chat Interface</button>
            <div class="info">
                <strong>Note:</strong> The chat interface will open in a new tab. Make sure you're logged in as either a client or lawyer.
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001/api';
        let clientToken = '';
        let lawyerToken = '';
        let testRequestId = '';

        async function setupTestRequest() {
            const resultDiv = document.getElementById('setupResult');
            resultDiv.innerHTML = '<div class="info">Setting up test request...</div>';

            try {
                // Step 1: Login as client using proper auth endpoint
                const clientLogin = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'client@test.com',
                        password: 'password123'
                    })
                });

                if (!clientLogin.ok) throw new Error('Client login failed');
                const clientData = await clientLogin.json();
                clientToken = clientData.access_token;

                // Step 2: Login as lawyer using proper auth endpoint
                const lawyerLogin = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'lawyer@test.com',
                        password: 'password123'
                    })
                });

                if (!lawyerLogin.ok) throw new Error('Lawyer login failed');
                const lawyerData = await lawyerLogin.json();
                lawyerToken = lawyerData.access_token;
                // Step 3: Send request using authenticated endpoint
                const requestResponse = await fetch(`${API_BASE}/requests/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify({
                        lawyer_id: lawyerData.user.id,
                        title: 'Chat System Test Request',
                        description: 'Testing the new chat functionality for accepted requests.',
                        category: 'General Legal Advice',
                        urgency_level: 'medium'
                    })
                });

                if (!requestResponse.ok) {
                    const errorData = await requestResponse.json();
                    throw new Error(`Failed to send request: ${errorData.detail || 'Unknown error'}`);
                }
                const requestResult = await requestResponse.json();
                testRequestId = requestResult.id;

                // Step 4: Accept request as lawyer
                const acceptResponse = await fetch(`${API_BASE}/requests/${testRequestId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${lawyerToken}`
                    },
                    body: JSON.stringify({
                        action: 'accept',
                        response_message: 'I accept your request. Let\'s discuss your legal needs.',
                        meeting_slots: [
                            {
                                date: '2024-02-01',
                                time: '10:00',
                                duration: 60,
                                meeting_type: 'online'
                            }
                        ]
                    })
                });

                if (!acceptResponse.ok) throw new Error('Failed to accept request');

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Test Request Setup Complete!</h4>
                        <p><strong>Request ID:</strong> ${testRequestId}</p>
                        <p><strong>Status:</strong> Accepted and ready for chat</p>
                        <p><strong>Client Token:</strong> ${clientToken.substring(0, 20)}...</p>
                        <p><strong>Lawyer Token:</strong> ${lawyerToken.substring(0, 20)}...</p>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Setup failed: ${error.message}</div>`;
            }
        }

        async function testChatConversations() {
            if (!clientToken) {
                alert('Please setup test request first!');
                return;
            }

            const resultDiv = document.getElementById('chatResult');
            resultDiv.innerHTML = '<div class="info">Loading conversations...</div>';

            try {
                // Test as client
                const clientConversations = await fetch(`${API_BASE}/chat/conversations`, {
                    headers: { 'Authorization': `Bearer ${clientToken}` }
                });

                if (!clientConversations.ok) throw new Error('Failed to load client conversations');
                const clientData = await clientConversations.json();

                // Test as lawyer
                const lawyerConversations = await fetch(`${API_BASE}/chat/conversations`, {
                    headers: { 'Authorization': `Bearer ${lawyerToken}` }
                });

                if (!lawyerConversations.ok) throw new Error('Failed to load lawyer conversations');
                const lawyerData = await lawyerConversations.json();

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Chat Conversations Loaded!</h4>
                        <p><strong>Client Conversations:</strong> ${clientData.length}</p>
                        <p><strong>Lawyer Conversations:</strong> ${lawyerData.length}</p>
                        <pre>${JSON.stringify(clientData, null, 2)}</pre>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Failed to load conversations: ${error.message}</div>`;
            }
        }

        async function sendTestMessage() {
            if (!testRequestId || !clientToken) {
                alert('Please setup test request first!');
                return;
            }

            const resultDiv = document.getElementById('chatResult');
            resultDiv.innerHTML = '<div class="info">Sending test message...</div>';

            try {
                // Send message as client
                const messageResponse = await fetch(`${API_BASE}/chat/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify({
                        request_id: testRequestId,
                        content: 'Hello! This is a test message from the client. The chat system is working great!',
                        message_type: 'text'
                    })
                });

                if (!messageResponse.ok) throw new Error('Failed to send message');
                const messageResult = await messageResponse.json();

                // Send reply as lawyer
                const replyResponse = await fetch(`${API_BASE}/chat/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${lawyerToken}`
                    },
                    body: JSON.stringify({
                        request_id: testRequestId,
                        content: 'Hello! Thank you for your message. I\'m ready to help with your legal needs. When would you like to schedule our meeting?',
                        message_type: 'text'
                    })
                });

                if (!replyResponse.ok) throw new Error('Failed to send reply');
                const replyResult = await replyResponse.json();

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Test Messages Sent Successfully!</h4>
                        <p><strong>Client Message ID:</strong> ${messageResult.id}</p>
                        <p><strong>Lawyer Reply ID:</strong> ${replyResult.id}</p>
                        <p>Both messages have been sent and stored in the database.</p>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Failed to send messages: ${error.message}</div>`;
            }
        }

        async function loadChatMessages() {
            if (!testRequestId || !clientToken) {
                alert('Please setup test request first!');
                return;
            }

            const resultDiv = document.getElementById('chatResult');
            resultDiv.innerHTML = '<div class="info">Loading chat messages...</div>';

            try {
                const messagesResponse = await fetch(`${API_BASE}/chat/${testRequestId}/messages`, {
                    headers: { 'Authorization': `Bearer ${clientToken}` }
                });

                if (!messagesResponse.ok) throw new Error('Failed to load messages');
                const messages = await messagesResponse.json();

                let messagesHtml = messages.map(msg => `
                    <div style="margin: 10px 0; padding: 10px; border-left: 3px solid ${msg.sender_type === 'client' ? '#007bff' : '#28a745'};">
                        <strong>${msg.sender_name} (${msg.sender_type}):</strong><br>
                        ${msg.content}<br>
                        <small style="color: #666;">${new Date(msg.timestamp).toLocaleString()}</small>
                    </div>
                `).join('');

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Chat Messages Loaded!</h4>
                        <p><strong>Total Messages:</strong> ${messages.length}</p>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
                            ${messagesHtml || '<p>No messages found.</p>'}
                        </div>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Failed to load messages: ${error.message}</div>`;
            }
        }

        function openChatInterface() {
            window.open('pages/chat.html', '_blank');
        }
    </script>
</body>
</html>