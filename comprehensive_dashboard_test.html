<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Dashboard Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { border: 1px solid #ddd; padding: 20px; margin: 15px 0; border-radius: 8px; background: #f9f9f9; }
        .error { color: red; background: #fee2e2; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { color: green; background: #d1fae5; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { color: blue; background: #dbeafe; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .warning { color: orange; background: #fef3c7; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #3b82f6; color: white; }
        button:hover { background: #2563eb; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; border: 1px solid #ddd; max-height: 300px; overflow-y: auto; }
        .meeting-link { margin: 10px 0; padding: 12px; background: #e0f2fe; border-radius: 8px; border-left: 4px solid #0284c7; }
        .meeting-link-btn { display: inline-flex; align-items: center; gap: 8px; background: #0284c7; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; margin-top: 8px; }
        .request-item { background: white; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .status-accepted { color: #10b981; font-weight: bold; }
        .status-pending { color: #f59e0b; font-weight: bold; }
        .status-rejected { color: #ef4444; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Comprehensive Dashboard Test</h1>
        <p>This test will identify all issues preventing meeting links from showing on dashboards.</p>
        
        <div class="test-section">
            <h2>Test 1: API Connectivity</h2>
            <button onclick="testAPIConnectivity()">Test API Connection</button>
            <div id="apiConnectivityResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 2: Authentication</h2>
            <button onclick="testAuthentication()">Test Login</button>
            <div id="authResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 3: Requests API</h2>
            <button onclick="testRequestsAPI()">Test Requests API</button>
            <div id="requestsResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 4: Cases API</h2>
            <button onclick="testCasesAPI()">Test Cases API</button>
            <div id="casesResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 5: Meeting Links Display</h2>
            <button onclick="testMeetingLinksDisplay()">Test Meeting Links Rendering</button>
            <div id="meetingLinksResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 6: Dashboard JavaScript Simulation</h2>
            <button onclick="simulateDashboardJS()">Simulate Dashboard Functions</button>
            <div id="dashboardJSResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 7: Complete Flow Test</h2>
            <button onclick="runCompleteFlowTest()">Run Complete Flow</button>
            <div id="completeFlowResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Summary & Recommendations</h2>
            <div id="summaryResults"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' ? 
            'http://localhost:8001/api' : 
            'https://jai-production-5c01.up.railway.app/api';
        
        let testResults = {
            apiConnectivity: false,
            clientAuth: false,
            lawyerAuth: false,
            clientRequests: false,
            lawyerRequests: false,
            clientCases: false,
            lawyerCases: false,
            meetingLinksFound: false,
            dashboardJS: false
        };
        
        let clientToken = null;
        let lawyerToken = null;
        let clientRequestsData = null;
        let lawyerRequestsData = null;

        async function testAPIConnectivity() {
            const results = document.getElementById('apiConnectivityResults');
            results.innerHTML = '<div class="info">Testing API connectivity...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test', password: 'test' })
                });
                
                if (response.status === 422 || response.status === 401) {
                    testResults.apiConnectivity = true;
                    results.innerHTML = '<div class="success">‚úÖ API is reachable and responding correctly</div>';
                } else {
                    results.innerHTML = `<div class="warning">‚ö†Ô∏è API responding but unexpected status: ${response.status}</div>`;
                }
            } catch (error) {
                testResults.apiConnectivity = false;
                results.innerHTML = `<div class="error">‚ùå API connection failed: ${error.message}</div>`;
            }
        }

        async function testAuthentication() {
            const results = document.getElementById('authResults');
            results.innerHTML = '<div class="info">Testing authentication...</div>';
            
            try {
                // Test client login
                const clientLogin = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'client@test.com',
                        password: 'password123'
                    })
                });
                
                if (clientLogin.ok) {
                    const clientData = await clientLogin.json();
                    clientToken = clientData.access_token;
                    testResults.clientAuth = true;
                    results.innerHTML += '<div class="success">‚úÖ Client authentication successful</div>';
                } else {
                    testResults.clientAuth = false;
                    results.innerHTML += `<div class="error">‚ùå Client authentication failed: ${clientLogin.status}</div>`;
                }
                
                // Test lawyer login
                const lawyerLogin = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'lawyer@test.com',
                        password: 'password123'
                    })
                });
                
                if (lawyerLogin.ok) {
                    const lawyerData = await lawyerLogin.json();
                    lawyerToken = lawyerData.access_token;
                    testResults.lawyerAuth = true;
                    results.innerHTML += '<div class="success">‚úÖ Lawyer authentication successful</div>';
                } else {
                    testResults.lawyerAuth = false;
                    results.innerHTML += `<div class="error">‚ùå Lawyer authentication failed: ${lawyerLogin.status}</div>`;
                }
                
            } catch (error) {
                results.innerHTML += `<div class="error">‚ùå Authentication test failed: ${error.message}</div>`;
            }
        }

        async function testRequestsAPI() {
            const results = document.getElementById('requestsResults');
            results.innerHTML = '<div class="info">Testing requests API...</div>';
            
            if (!clientToken || !lawyerToken) {
                results.innerHTML = '<div class="warning">‚ö†Ô∏è Please run authentication test first</div>';
                return;
            }
            
            try {
                // Test client requests
                const clientRequests = await fetch(`${API_BASE_URL}/requests/`, {
                    headers: { 'Authorization': `Bearer ${clientToken}` }
                });
                
                if (clientRequests.ok) {
                    clientRequestsData = await clientRequests.json();
                    testResults.clientRequests = true;
                    const meetingLinksCount = clientRequestsData.filter(req => req.meeting_link).length;
                    results.innerHTML += `<div class="success">‚úÖ Client requests API working - ${clientRequestsData.length} requests, ${meetingLinksCount} with meeting links</div>`;
                    
                    if (meetingLinksCount > 0) {
                        testResults.meetingLinksFound = true;
                        results.innerHTML += '<div class="success">üîó Meeting links found in API response!</div>';
                    }
                } else {
                    testResults.clientRequests = false;
                    results.innerHTML += `<div class="error">‚ùå Client requests API failed: ${clientRequests.status}</div>`;
                }
                
                // Test lawyer requests
                const lawyerRequests = await fetch(`${API_BASE_URL}/requests/`, {
                    headers: { 'Authorization': `Bearer ${lawyerToken}` }
                });
                
                if (lawyerRequests.ok) {
                    lawyerRequestsData = await lawyerRequests.json();
                    testResults.lawyerRequests = true;
                    const lawyerMeetingLinksCount = lawyerRequestsData.filter(req => req.meeting_link).length;
                    results.innerHTML += `<div class="success">‚úÖ Lawyer requests API working - ${lawyerRequestsData.length} requests, ${lawyerMeetingLinksCount} with meeting links</div>`;
                } else {
                    testResults.lawyerRequests = false;
                    results.innerHTML += `<div class="error">‚ùå Lawyer requests API failed: ${lawyerRequests.status}</div>`;
                }
                
            } catch (error) {
                results.innerHTML += `<div class="error">‚ùå Requests API test failed: ${error.message}</div>`;
            }
        }

        async function testCasesAPI() {
            const results = document.getElementById('casesResults');
            results.innerHTML = '<div class="info">Testing cases API...</div>';
            
            if (!clientToken || !lawyerToken) {
                results.innerHTML = '<div class="warning">‚ö†Ô∏è Please run authentication test first</div>';
                return;
            }
            
            try {
                // Test client cases
                const clientCases = await fetch(`${API_BASE_URL}/cases/`, {
                    headers: { 'Authorization': `Bearer ${clientToken}` }
                });
                
                if (clientCases.ok) {
                    const clientCasesData = await clientCases.json();
                    testResults.clientCases = true;
                    results.innerHTML += `<div class="success">‚úÖ Client cases API working - ${clientCasesData.cases ? clientCasesData.cases.length : 0} cases</div>`;
                } else {
                    testResults.clientCases = false;
                    results.innerHTML += `<div class="error">‚ùå Client cases API failed: ${clientCases.status}</div>`;
                }
                
                // Test lawyer cases
                const lawyerCases = await fetch(`${API_BASE_URL}/cases/`, {
                    headers: { 'Authorization': `Bearer ${lawyerToken}` }
                });
                
                if (lawyerCases.ok) {
                    const lawyerCasesData = await lawyerCases.json();
                    testResults.lawyerCases = true;
                    results.innerHTML += `<div class="success">‚úÖ Lawyer cases API working - ${lawyerCasesData.cases ? lawyerCasesData.cases.length : 0} cases</div>`;
                } else {
                    testResults.lawyerCases = false;
                    const errorText = await lawyerCases.text();
                    results.innerHTML += `<div class="error">‚ùå Lawyer cases API failed: ${lawyerCases.status} - ${errorText}</div>`;
                }
                
            } catch (error) {
                results.innerHTML += `<div class="error">‚ùå Cases API test failed: ${error.message}</div>`;
            }
        }

        async function testMeetingLinksDisplay() {
            const results = document.getElementById('meetingLinksResults');
            results.innerHTML = '<div class="info">Testing meeting links display...</div>';
            
            if (!clientRequestsData) {
                results.innerHTML = '<div class="warning">‚ö†Ô∏è Please run requests API test first</div>';
                return;
            }
            
            const requestsWithMeetingLinks = clientRequestsData.filter(req => req.meeting_link);
            
            if (requestsWithMeetingLinks.length === 0) {
                results.innerHTML += '<div class="warning">‚ö†Ô∏è No meeting links found in requests data</div>';
                return;
            }
            
            results.innerHTML += `<div class="success">‚úÖ Found ${requestsWithMeetingLinks.length} requests with meeting links</div>`;
            
            // Display the meeting links
            requestsWithMeetingLinks.forEach(request => {
                results.innerHTML += `
                    <div class="request-item">
                        <h4>${request.title}</h4>
                        <p><strong>Status:</strong> <span class="status-${request.status}">${request.status}</span></p>
                        <div class="meeting-link">
                            <strong>üîó Meeting Link:</strong>
                            <a href="${request.meeting_link.join_url}" target="_blank" class="meeting-link-btn">
                                üé• Join Meeting
                            </a>
                            <div style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">
                                Provider: ${request.meeting_link.provider} | 
                                Meeting ID: ${request.meeting_link.meeting_id} | 
                                Created: ${new Date(request.meeting_link.created_at).toLocaleDateString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            testResults.dashboardJS = true;
        }

        async function simulateDashboardJS() {
            const results = document.getElementById('dashboardJSResults');
            results.innerHTML = '<div class="info">Simulating dashboard JavaScript functions...</div>';
            
            if (!clientRequestsData) {
                results.innerHTML = '<div class="warning">‚ö†Ô∏è Please run requests API test first</div>';
                return;
            }
            
            try {
                // Simulate the exact displayClientRequests function from the dashboard
                const container = document.createElement('div');
                
                if (clientRequestsData.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No requests sent yet.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = clientRequestsData.slice(0, 3).map(function(request) {
                        const statusClass = request.status === 'pending' ? 'status-pending' : 
                                          request.status === 'accepted' ? 'status-accepted' : 'status-rejected';
                        
                        const statusIcon = request.status === 'pending' ? 'clock' : 
                                         request.status === 'accepted' ? 'check-circle' : 'times-circle';
                        
                        const showChatButton = request.status === 'accepted' || request.status === 'rejected';
                        
                        return `
                            <div class="request-item">
                                <div class="request-header">
                                    <div class="request-info">
                                        <h4>${request.title}</h4>
                                        <div class="request-meta">
                                            <span>üë®‚Äçüíº ${request.lawyer_name}</span>
                                            <span>üè∑Ô∏è ${request.category}</span>
                                            <span class="request-status ${statusClass}">
                                                üìä ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="request-actions">
                                        ${showChatButton ? `
                                            <button class="chat-btn" title="Open Chat">
                                                üí¨ Chat
                                            </button>
                                        ` : ''}
                                        <div class="request-date">
                                            ${new Date(request.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                                ${request.meeting_link ? `
                                    <div class="meeting-link">
                                        <strong>Meeting Link:</strong>
                                        <a href="${request.meeting_link.join_url}" target="_blank" class="meeting-link-btn">
                                            üé• Join Meeting
                                        </a>
                                        <div class="meeting-info">
                                            Provider: ${request.meeting_link.provider} | Created: ${new Date(request.meeting_link.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                ` : ''}
                                ${request.response_message ? `
                                    <div class="response-message">
                                        <strong>Response:</strong> ${request.response_message}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                }
                
                results.innerHTML += '<div class="success">‚úÖ Dashboard JavaScript simulation successful</div>';
                results.innerHTML += '<div class="info"><strong>Simulated Dashboard Output:</strong></div>';
                results.innerHTML += container.innerHTML;
                
                testResults.dashboardJS = true;
                
            } catch (error) {
                results.innerHTML += `<div class="error">‚ùå Dashboard JS simulation failed: ${error.message}</div>`;
            }
        }

        async function runCompleteFlowTest() {
            const results = document.getElementById('completeFlowResults');
            results.innerHTML = '<div class="info">Running complete flow test...</div>';
            
            // Run all tests in sequence
            await testAPIConnectivity();
            await testAuthentication();
            await testRequestsAPI();
            await testCasesAPI();
            await testMeetingLinksDisplay();
            await simulateDashboardJS();
            
            // Generate summary
            generateSummary();
            
            results.innerHTML += '<div class="success">‚úÖ Complete flow test finished - check summary below</div>';
        }

        function generateSummary() {
            const results = document.getElementById('summaryResults');
            
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const totalTests = Object.keys(testResults).length;
            
            let summary = `<h3>Test Results: ${passedTests}/${totalTests} passed</h3>`;
            
            // Individual test results
            summary += '<div class="test-results">';
            for (const [test, passed] of Object.entries(testResults)) {
                const status = passed ? '‚úÖ' : '‚ùå';
                const className = passed ? 'success' : 'error';
                summary += `<div class="${className}">${status} ${test}: ${passed ? 'PASSED' : 'FAILED'}</div>`;
            }
            summary += '</div>';
            
            // Recommendations
            summary += '<h3>Recommendations:</h3>';
            
            if (!testResults.apiConnectivity) {
                summary += '<div class="error">üîß Fix API connectivity issues first</div>';
            } else if (!testResults.clientAuth || !testResults.lawyerAuth) {
                summary += '<div class="error">üîß Fix authentication issues</div>';
            } else if (!testResults.clientRequests || !testResults.lawyerRequests) {
                summary += '<div class="error">üîß Fix requests API issues</div>';
            } else if (!testResults.lawyerCases) {
                summary += '<div class="error">üîß Fix lawyer cases API (500 error)</div>';
            } else if (!testResults.meetingLinksFound) {
                summary += '<div class="warning">‚ö†Ô∏è No meeting links found - create more test requests with accepted status</div>';
            } else if (testResults.meetingLinksFound && testResults.dashboardJS) {
                summary += '<div class="success">‚úÖ Meeting links are working! The issue might be with the actual dashboard pages loading or JavaScript execution.</div>';
                summary += '<div class="info">üí° Recommended next steps:<br>1. Check browser console for JavaScript errors on actual dashboard pages<br>2. Verify that the dashboard pages are loading the correct API endpoints<br>3. Test the actual dashboard pages in a browser</div>';
            }
            
            results.innerHTML = summary;
        }
    </script>
</body>
</html>