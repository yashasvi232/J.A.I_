<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Meeting Links Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { border: 1px solid #ddd; padding: 20px; margin: 15px 0; border-radius: 8px; background: #f9f9f9; }
        .error { color: red; background: #fee2e2; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { color: green; background: #d1fae5; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { color: blue; background: #dbeafe; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .warning { color: orange; background: #fef3c7; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #3b82f6; color: white; }
        button:hover { background: #2563eb; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
        .meeting-link { margin: 10px 0; padding: 12px; background: #e0f2fe; border-radius: 8px; border-left: 4px solid #0284c7; }
        .meeting-link-btn { display: inline-flex; align-items: center; gap: 8px; background: #0284c7; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; margin-top: 8px; }
        .request-item { background: white; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .status-accepted { color: #10b981; font-weight: bold; }
        .status-pending { color: #f59e0b; font-weight: bold; }
        .status-rejected { color: #ef4444; font-weight: bold; }
        iframe { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0; }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #3b82f6; background: #f8fafc; }
        .step h3 { margin-top: 0; color: #1e40af; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Final Meeting Links Test</h1>
        <p>This comprehensive test will identify and solve the meeting links issue.</p>
        
        <div class="step">
            <h3>üìã Test Summary</h3>
            <p><strong>Problem:</strong> Meeting links not showing in dashboard UI</p>
            <p><strong>Expected:</strong> "PowerShell Test Request" should have a blue "Join Meeting" button</p>
            <p><strong>Backend Status:</strong> ‚úÖ Working (meeting links generated correctly)</p>
            <p><strong>Issue Location:</strong> Frontend UI rendering</p>
        </div>
        
        <div class="test-section">
            <h2>Step 1: Backend Verification</h2>
            <button onclick="testBackend()">Test Backend API</button>
            <div id="backendResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Step 2: Meeting Links API Test</h2>
            <button onclick="testMeetingLinksAPI()" id="apiTestBtn" disabled>Test Meeting Links API</button>
            <div id="apiResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Step 3: Dashboard Function Simulation</h2>
            <button onclick="simulateDashboard()" id="simulateBtn" disabled>Simulate Dashboard</button>
            <div id="simulationResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Step 4: Actual Dashboard Test</h2>
            <button onclick="loadActualDashboard()">Load Actual Dashboard</button>
            <div class="info">
                <strong>Instructions:</strong><br>
                1. Click the button above to load the real dashboard<br>
                2. Login with: <strong>client@test.com</strong> / <strong>password123</strong><br>
                3. Look for "PowerShell Test Request" with meeting link<br>
                4. If no meeting link appears, check browser console (F12) for errors
            </div>
            <div id="dashboardFrame"></div>
        </div>
        
        <div class="test-section">
            <h2>Step 5: Troubleshooting Guide</h2>
            <div class="warning">
                <strong>If meeting links still don't show:</strong><br>
                1. <strong>Hard Refresh:</strong> Press Ctrl+Shift+R to clear cache<br>
                2. <strong>Check Console:</strong> Open F12 ‚Üí Console tab, look for red errors<br>
                3. <strong>Try Incognito:</strong> Test in private/incognito browser window<br>
                4. <strong>Different Browser:</strong> Try Chrome, Firefox, or Edge<br>
                5. <strong>Clear Data:</strong> Clear all browser data and cookies
            </div>
        </div>
        
        <div class="test-section">
            <h2>Expected Result</h2>
            <div class="success">
                <strong>‚úÖ What you should see:</strong><br>
                - Login successful as client@test.com<br>
                - "PowerShell Test Request" in requests list<br>
                - Blue "Join Meeting" button<br>
                - Clicking opens: https://meet.google.com/97ffbe0428
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8001/api';
        let authToken = null;
        let requestsData = null;
        
        async function testBackend() {
            const results = document.getElementById('backendResults');
            results.innerHTML = '<div class="info">Testing backend connection...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test', password: 'test' })
                });
                
                if (response.status === 422 || response.status === 401) {
                    results.innerHTML = '<div class="success">‚úÖ Backend API is running and responding correctly</div>';
                    document.getElementById('apiTestBtn').disabled = false;
                } else {
                    results.innerHTML = `<div class="warning">‚ö†Ô∏è Backend responding but unexpected status: ${response.status}</div>`;
                }
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Backend connection failed: ${error.message}<br><strong>Solution:</strong> Make sure to run: python backend/main.py</div>`;
            }
        }
        
        async function testMeetingLinksAPI() {
            const results = document.getElementById('apiResults');
            results.innerHTML = '<div class="info">Testing meeting links API...</div>';
            
            try {
                // Login
                const loginResponse = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'client@test.com',
                        password: 'password123'
                    })
                });
                
                if (!loginResponse.ok) {
                    results.innerHTML = '<div class="error">‚ùå Login failed - check credentials</div>';
                    return;
                }
                
                const loginData = await loginResponse.json();
                authToken = loginData.access_token;
                results.innerHTML += '<div class="success">‚úÖ Login successful</div>';
                
                // Get requests
                const requestsResponse = await fetch(`${API_BASE_URL}/requests/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!requestsResponse.ok) {
                    results.innerHTML += '<div class="error">‚ùå Failed to fetch requests</div>';
                    return;
                }
                
                requestsData = await requestsResponse.json();
                results.innerHTML += `<div class="success">‚úÖ Fetched ${requestsData.length} requests</div>`;
                
                // Check for meeting links
                const meetingLinkRequests = requestsData.filter(req => req.meeting_link);
                results.innerHTML += `<div class="info">üìã Requests with meeting links: ${meetingLinkRequests.length}/${requestsData.length}</div>`;
                
                if (meetingLinkRequests.length > 0) {
                    meetingLinkRequests.forEach(req => {
                        results.innerHTML += `
                            <div class="success">
                                ‚úÖ Found meeting link in "${req.title}":<br>
                                - URL: <a href="${req.meeting_link.join_url}" target="_blank">${req.meeting_link.join_url}</a><br>
                                - Provider: ${req.meeting_link.provider}<br>
                                - Meeting ID: ${req.meeting_link.meeting_id}
                            </div>
                        `;
                    });
                    results.innerHTML += '<div class="success">‚úÖ Meeting links found in API! Backend is working correctly.</div>';
                    document.getElementById('simulateBtn').disabled = false;
                } else {
                    results.innerHTML += '<div class="error">‚ùå No meeting links found in API data! Backend issue.</div>';
                }
                
            } catch (error) {
                results.innerHTML += `<div class="error">‚ùå API test error: ${error.message}</div>`;
            }
        }
        
        async function simulateDashboard() {
            const results = document.getElementById('simulationResults');
            results.innerHTML = '<div class="info">Simulating dashboard rendering...</div>';
            
            if (!requestsData) {
                results.innerHTML = '<div class="error">‚ùå No requests data - run API test first</div>';
                return;
            }
            
            try {
                // Simulate the exact displayClientRequests function
                const simulatedHTML = requestsData.slice(0, 3).map(function(request) {
                    const statusClass = request.status === 'pending' ? 'status-pending' : 
                                      request.status === 'accepted' ? 'status-accepted' : 'status-rejected';
                    
                    return `
                        <div class="request-item">
                            <h4>${request.title}</h4>
                            <p><strong>Lawyer:</strong> ${request.lawyer_name}</p>
                            <p><strong>Status:</strong> <span class="${statusClass}">${request.status}</span></p>
                            <p><strong>Category:</strong> ${request.category}</p>
                            <p><strong>Date:</strong> ${new Date(request.created_at).toLocaleDateString()}</p>
                            
                            ${request.meeting_link ? `
                                <div class="meeting-link">
                                    <strong>üîó Meeting Link:</strong>
                                    <a href="${request.meeting_link.join_url}" target="_blank" class="meeting-link-btn">
                                        üé• Join Meeting
                                    </a>
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">
                                        Provider: ${request.meeting_link.provider} | Created: ${new Date(request.meeting_link.created_at).toLocaleDateString()}
                                    </div>
                                </div>
                            ` : '<div class="error">‚ùå No meeting link available</div>'}
                            
                            ${request.response_message ? `
                                <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 10px;">
                                    <strong>Response:</strong> ${request.response_message}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
                results.innerHTML = '<div class="success">‚úÖ Dashboard simulation successful</div>';
                results.innerHTML += '<div class="info"><strong>Simulated Dashboard Output:</strong></div>';
                results.innerHTML += simulatedHTML;
                
                // Check if PowerShell Test Request has meeting link
                const powershellRequest = requestsData.find(req => req.title.includes('PowerShell'));
                if (powershellRequest && powershellRequest.meeting_link) {
                    results.innerHTML += '<div class="success">‚úÖ "PowerShell Test Request" has meeting link - dashboard should work!</div>';
                } else {
                    results.innerHTML += '<div class="warning">‚ö†Ô∏è "PowerShell Test Request" missing meeting link</div>';
                }
                
            } catch (error) {
                results.innerHTML += `<div class="error">‚ùå Simulation error: ${error.message}</div>`;
            }
        }
        
        function loadActualDashboard() {
            const frame = document.getElementById('dashboardFrame');
            frame.innerHTML = '<iframe src="http://localhost:8001/pages/client-dashboard.html"></iframe>';
        }
        
        // Auto-run backend test on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testBackend();
            }, 1000);
        });
    </script>
</body>
</html>